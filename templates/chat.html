{% extends "base.html" %}

{% block content %}

<div class="chat-container">

    <div class="chat-header">
        <h2>ðŸ¤– Journal Assistant</h2>
        <p>Your personal journaling companion</p>
    </div>

    <div class="chat-messages" id="messages">
        {% for msg in history %}
            <div class="message {{ msg.role }}">
                <div class="bubble">{{ msg.content }}</div>
            </div>
        {% endfor %}
    </div>

    <div class="chat-input">
        <input
            type="text"
            id="messageInput"
            placeholder="Type your message..."
            autocomplete="off"
        >
        <button id="sendBtn" onclick="sendMessage()">Send â†’</button>
    </div>

</div>

<script>
    // â”€â”€ Scroll to bottom â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function scrollToBottom() {
        const messages = document.getElementById("messages");
        messages.scrollTop = messages.scrollHeight;
    }
    scrollToBottom();

    // â”€â”€ Add message bubble to UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function addMessage(role, content) {
        const messages = document.getElementById("messages");
        const div      = document.createElement("div");
        div.className  = `message ${role}`;
        div.innerHTML  = `<div class="bubble">${content}</div>`;
        messages.appendChild(div);
        scrollToBottom();
    }

    // â”€â”€ Typing indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showTyping() {
        const messages = document.getElementById("messages");
        const div      = document.createElement("div");
        div.className  = "message assistant";
        div.id         = "typing";
        div.innerHTML  = `<div class="bubble typing">
                            <span></span><span></span><span></span>
                          </div>`;
        messages.appendChild(div);
        scrollToBottom();
    }

    function hideTyping() {
        const typing = document.getElementById("typing");
        if (typing) typing.remove();
    }

    // â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function sendMessage() {
        const input  = document.getElementById("messageInput");
        const button = document.getElementById("sendBtn");
        const text   = input.value.trim();

        if (!text) return;

        // Show user message immediately
        addMessage("user", text);
        input.value = "";

        // Disable input while waiting
        input.disabled    = true;
        button.disabled   = true;
        button.textContent = "..."

        // Show typing indicator
        showTyping();

        try {
            const response = await fetch("/chat/send", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({message: text})
            });

            const data = await response.json();

            // Hide typing, show response
            hideTyping();
            addMessage("assistant", data.reply);

            // Show journal saved notification
            if (data.journal_saved) {
                addMessage("assistant", "âœ… Journal entry saved to your notes!");
            }

        } catch (error) {
            hideTyping();
            addMessage("assistant", "Something went wrong. Please try again.");
        }

        // Re-enable input
        input.disabled    = false;
        button.disabled   = false;
        button.textContent = "Send â†’";
        input.focus();
    }

    // â”€â”€ Send on Enter key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById("messageInput").addEventListener("keypress", function(e) {
        if (e.key === "Enter") sendMessage();
    });
</script>

{% endblock %}